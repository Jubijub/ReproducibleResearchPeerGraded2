---
title: "Reproducible Research Week 4 Peer Graded project 2"
author: "Jubijub"
date: "2 janvier 2017"
output: html_document
---

```{r setup, include=FALSE}
options(scipen=999)
knitr::opts_chunk$set(fig.path='figure/fig', echo = TRUE)
```
# Consequences of climate events on US population and properties between 1950 and 2011 based on U.S. National Oceanic and Atmospheric Administrationâ€™s (NOAA) storm database.

## Synopsis
(this paper is based on a Coursera Data Science - Reproducible research peer graded assignment).
The goal of this study is to explore the effects of climate events on US population health as well as the economic impacts of such events (damage to properties), in order to determine which type of events have been the most impacting in each case.
Such study should be able to inform administration actions toward preventing or minimising the effects of such natural events.

## Data processing

### Downloading data from the web
```{r init}
suppressMessages(library(R.utils))
projectData <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
bunzip2File <- "./StormData.csv.bz2"

if (!file.exists(bunzip2File)) {
    download.file(projectData, bunzip2File)
    message("Source File downloaded")
} else {
    message("Source File already present in this folder.")
}

if (file.exists(bunzip2File)) {
    bunzip2(bunzip2File, ext="bz2", FUN=bzfile, skip=TRUE, remove=FALSE)
    message("Bunzip2 file content extracted")
} 

```
### Loading data

```{r load, cache=TRUE}
library(data.table)
system.time(noaa <- read.csv("StormData.csv", header=TRUE))
system.time(noaa2 <- fread("StormData.csv", showProgress = FALSE))
noaa <- noaa2
rm(noaa2)
```
Due to the speed gains, this analysis will use data.table package

### Quick analysis of the data
```{r analyze1, cache=TRUE}
dim(noaa)
```

There are 902297 observations of 37 variables. However, only 8 variables will present an interest for this analysis : State, Event type (EVTYPE), # of Fatalities (FATALITIES), # of Injuries (INJURIES), Property damages (PROPDMG), Property damage exponent (PROPDMGEXP), Crop damages (CROPDMG) and Crop damages exponent (CROPDMGEXP).

### Data processing
```{r clean1, cache=TRUE}
noaa <- noaa[,.(STATE, EVTYPE, FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)]
head(noaa)
str(noaa)
sum(is.na(noaa))
unique(noaa$PROPDMGEXP)
unique(noaa$CROPDMGEXP)
head(unique(noaa$EVTYPE),60)
```
No missing data, however data about exponent is encoded, and no usable as such.
`EVTYPE` also requires some cleanup (presence of summary lines, etc...)

#### EXPonent Cleaning approach : 

* Find all the possible values for EXP columns
* create a mapping table, giving the numeric power value matching each EXP symbol.
* Invalid exponent values are translated into 0
A matching table `expTable` will be built accordingly.
```{r cleanexp, cache=TRUE}
symbols <- unique(c(unique(noaa$PROPDMGEXP), unique(noaa$CROPDMGEXP)))
#"K" "M" ""  "B" "m" "+" "0" "5" "6" "?" "4" "2" "3" "h" "7" "H" "-" "1" "8" "k"
# The list of symbols below has been rearranged manually, to ease maintenance
symbols <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "h", "H", "k", "K", "m", "M", "b", "B","", "+", "-", "?")
expValue <- c(seq(0,9),2,2,3,3,6,6,9,9,0,0,0,0)
expTable <- data.frame(symbols, expValue)
```

Two new columns have been created :

* `PROPDMGVALUE` : contains the USD value of Property damages
* `CROPDMGVALUE` : contains the USD value of Crop damages

Both columns have been created according to the formula :

    xxxDMG * 10 ^ xxxEXP

where the `xxx` is PROP|CROP, and where `xxxEXP` is the translated exponent value found in the matching table built above.

```{r cleanexp2, cache=TRUE}
noaa[, PROPDGMGVALUE := PROPDMG * 10 ^ expTable[match(PROPDMGEXP, expTable$symbols),2]]
noaa[, CROPPDGMGVALUE := CROPDMG * 10 ^ expTable[match(CROPDMGEXP, expTable$symbols),2]]
```
We now have a tidy dataset to perform the analysis.

#### EVTYPE cleaning approach

* Put all event type in uppercase
* Trim leading / trailing spaces
* Remove all lines containing `SUMMARY` which are likely polluting the results
* Cleaning some abbreviations / mispelling
* Grouping some elements into one single category


```{r cleanevt, cache=TRUE}
library(stringr)
noaa[, EVTYPE:=toupper(EVTYPE)]
noaa[, EVTYPE:=trimws(EVTYPE)]
noaa <- noaa[!(EVTYPE %like% "SUMMARY")]

noaa[EVTYPE %like% "TSTM WIND", EVTYPE := "THUNDERSTORM WINDS"]
noaa[EVTYPE %like% "THUNDERSTORM", EVTYPE := "THUNDERSTORM WINDS"]
noaa[EVTYPE %like% "TORNADO", EVTYPE := "TORNADO"]
noaa[EVTYPE %like% "FLOOD", EVTYPE := "FLOOD"]
```


## Results
```{r fatalities, cache=TRUE}
fatalities <- noaa[, .(FATALITIES=sum(FATALITIES)), by=EVTYPE]
fatalities <- fatalities[order(-FATALITIES)]
fatalities <- transform(fatalities, EVTYPE=reorder(EVTYPE, -FATALITIES))

library(ggplot2)
g <- ggplot(fatalities[1:30], aes(EVTYPE,FATALITIES))
g + geom_bar(stat="identity", aes(fill=FATALITIES)) +
    theme_light() +
    theme(axis.text.x= element_text(angle=90, vjust=0.5, size=8)) +
    xlab("Type of events") +
    ylab("Total number of fatalities") +
    ggtitle("Total number of fatalities in the US between 1950 and 2011 by type of climate event")

```
